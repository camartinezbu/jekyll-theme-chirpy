<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Mapas de calor como calendarios en R" /><meta name="author" content="Camilo Martínez" /><meta property="og:locale" content="en_US" /><meta name="description" content="Una manera creativa de presentar datos con fechas." /><meta property="og:description" content="Una manera creativa de presentar datos con fechas." /><link rel="canonical" href="https://camartinezbu.github.io/posts/mapas-de-calor-como-calendarios-en-R/" /><meta property="og:url" content="https://camartinezbu.github.io/posts/mapas-de-calor-como-calendarios-en-R/" /><meta property="og:site_name" content="Camilo Martínez" /><meta property="og:image" content="https://camartinezbu.github.io/assets/img/posts/2021-05-19-mapas-de-calor-como-calendarios-en-R/hero.jpg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-05-19T11:30:00-05:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://camartinezbu.github.io/assets/img/posts/2021-05-19-mapas-de-calor-como-calendarios-en-R/hero.jpg" /><meta property="twitter:title" content="Mapas de calor como calendarios en R" /><meta name="twitter:site" content="@camartinezbu" /><meta name="twitter:creator" content="@Camilo Martínez" /><meta name="google-site-verification" content="mI98zLX_Z1qeRqSmCMc6j_S7_S1UEBSsD9K_Ld_VHl0" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Camilo Martínez"},"description":"Una manera creativa de presentar datos con fechas.","url":"https://camartinezbu.github.io/posts/mapas-de-calor-como-calendarios-en-R/","image":"https://camartinezbu.github.io/assets/img/posts/2021-05-19-mapas-de-calor-como-calendarios-en-R/hero.jpg","@type":"BlogPosting","headline":"Mapas de calor como calendarios en R","dateModified":"2021-05-20T10:40:39-05:00","datePublished":"2021-05-19T11:30:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://camartinezbu.github.io/posts/mapas-de-calor-como-calendarios-en-R/"},"@context":"https://schema.org"}</script><title>Mapas de calor como calendarios en R | Camilo Martínez</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-173730939-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-173730939-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/sample/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Camilo Martínez</a></div><div class="site-subtitle font-italic">Un blog sobre ciencia de datos y programación.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>INICIO</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORÍAS</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>ETIQUETAS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVO</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>SOBRE MI</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/camartinezbu" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/camartinezbu" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['camartinezbu.contacto','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="" aria-label="linkedin" class="order-6" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Publicaciones </a> </span> <span>Mapas de calor como calendarios en R</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Buscar..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Mapas de calor como calendarios en R</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " > May 19 <i class="unloaded">2021-05-19T11:30:00-05:00</i> </span> por <span class="author"> Camilo Martínez </span></div><div> <span> Actualizado el <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, May 20, 2021, 10:40 AM -0500" > May 20 <i class="unloaded">2021-05-20T10:40:39-05:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1213 palabras">6 min</span></div></div><div class="post-content"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/2021-05-19-mapas-de-calor-como-calendarios-en-R/hero.jpg" class="preview-img"><p>Después de una pausa de algunas semanas vuelvo a escribir posts semanales en el blog. Para comenzar, quiero compartirles una visualización que me llamó mucho la atención al leer el libro <a href="https://www.amazon.com/Better-Data-Visualizations-Scholars-Researchers/dp/0231193114">Better Data Visualizations</a> de Jonathan Schwabish: Los <em>Heatmap calendars</em>, que acá voy a traducir -probablemente mal- como mapas de calor en forma de calendarios. Buena parte del insumo para este post viene de <a href="https://vietle.info/post/calendarheatmap/">este tutorial</a> de Viet Le.</p><h2 id="paquetes-necesarios">Paquetes necesarios</h2><p>Para este ejercicio voy a usar los siguientes paquetes: <code class="language-plaintext highlighter-rouge">readxl</code> para importar la base de datos que se encuentran en un archivo .xls, el <code class="language-plaintext highlighter-rouge">tidyverse</code> para la limpieza de los datos y la visualización con <code class="language-plaintext highlighter-rouge">ggplot2</code>, y <code class="language-plaintext highlighter-rouge">lubridate</code> para un par de operaciones puntuales con las fechas.</p><p>Adicionalmente, usaré <code class="language-plaintext highlighter-rouge">shadowtext</code> para mejorar un poco la legibilidad del texto en el calendario al añadir sombras. Sin embargo, esto no es fundamental para hacer el calendar heatmap.</p><h2 id="los-datos">Los datos</h2><p>Voy a usar un archivo de excel que contiene los registros de violencia intrafamiliar en Colombia durante 2019, disponibles para descarga en la página de <a href="https://www.policia.gov.co/grupo-informaci%C3%B3n-criminalidad/estadistica-delictiva">Estadística Delictiva de la Policía Nacional</a>.</p><p>Esta base de datos contiene los siguientes campos de información: Departamento, Municipio, Código DIVIPOLA del municipio, Arma empleada, Fecha del registro, Sexo de la víctima, Grupo de edad de la víctima y un contador de cantidad de hechos. Para este ejercicio sólo nos interesa usar la fecha.</p><h2 id="importación">Importación</h2><p>Lo primero que hay que hacer es cargar los paquetes que vamos a usar. Posteriormente, cargo la base de datos llamando de la función <code class="language-plaintext highlighter-rouge">read_xlsx()</code> del paquete <code class="language-plaintext highlighter-rouge">readxl</code> y la guardo en un objeto llamado <code class="language-plaintext highlighter-rouge">vif</code>.</p><p>Adicionalmente, y por buenas prácticas, voy a definir la zona horaria de las fechas registradas en Bogotá con la función <code class="language-plaintext highlighter-rouge">tz()</code>.</p><div class="language-r highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">readxl</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">lubridate</span><span class="p">)</span><span class="w">

</span><span class="n">vif</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_xlsx</span><span class="p">(</span><span class="s2">"~/Downloads/violencia_intrafamiliar_2019_0.xlsx"</span><span class="p">,</span><span class="w"> 
                 </span><span class="n">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cell_limits</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">11</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">113894</span><span class="p">,</span><span class="w"> </span><span class="m">8</span><span class="p">)))</span><span class="w">

</span><span class="n">tz</span><span class="p">(</span><span class="n">vif</span><span class="o">$</span><span class="n">`FECHA HECHO`</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"America/Bogota"</span><span class="w">
</span></pre></table></code></div></div><p>Acá vale la pena mencionar que por alguna razón escribir el rango de las celdas en el argumento <code class="language-plaintext highlighter-rouge">range</code> de <code class="language-plaintext highlighter-rouge">read_xslx()</code> en la forma <code class="language-plaintext highlighter-rouge">A1:H113894</code> me generaba un error en la lectura. Una búsqueda rápida en internet me llevó a escribir el rango dentro de la función <code class="language-plaintext highlighter-rouge">cell_limits()</code>, lo que corrigió el problema.</p><h2 id="procesamiento">Procesamiento</h2><p>Aquí viene la parte mas importante. En esencia, lo que hacemos para hacer el mapa de calor en forma de calendario es colorear doce grillas de 7x4 -7 días y 4 semanas-, donde el color de cada celda obedece a un conteo de registros de violencia intrafamiliar.</p><p>Sin embargo, como el resultado final debe parecer un calendario, necesitamos definir para cada registro en qué semana del mes y en qué día de la semana ocurrió. De lo contrario todos los meses empezarían el mismo día. Lunes o domingo, dependiendo del formato de calendario que se quiera usar.</p><p>Para ello, vamos a ejecutar el siguiente bloque de código:</p><div class="language-r highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="n">historico_diario</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vif</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">transmute</span><span class="p">(</span><span class="n">FECHA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ymd</span><span class="p">(</span><span class="n">`FECHA HECHO`</span><span class="p">),</span><span class="w"> </span><span class="n">CANTIDAD</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">FECHA</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">summarise</span><span class="p">(</span><span class="n">REGISTROS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">CANTIDAD</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ungroup</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">DIA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wday</span><span class="p">(</span><span class="n">FECHA</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">week_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">locale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"es_ES"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">MES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">month</span><span class="p">(</span><span class="n">FECHA</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">locale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"es_ES"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">SEMANA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isoweek</span><span class="p">(</span><span class="n">FECHA</span><span class="p">))</span><span class="w">

</span><span class="n">historico_diario</span><span class="o">$</span><span class="n">SEMANA</span><span class="p">[</span><span class="n">historico_diario</span><span class="o">$</span><span class="n">MES</span><span class="o">==</span><span class="s2">"dic"</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">historico_diario</span><span class="o">$</span><span class="n">SEMANA</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">53</span><span class="w"> 

</span><span class="n">historico_diario</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">historico_diario</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">group_by</span><span class="p">(</span><span class="n">MES</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">SEMANA_MES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SEMANA</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">min</span><span class="p">(</span><span class="n">SEMANA</span><span class="p">))</span><span class="w">

</span></pre></table></code></div></div><p>Vamos por partes. En el primer bloque de código creo una variable <code class="language-plaintext highlighter-rouge">FECHA</code> que contiene la fecha de la base de datos original en un formato que puede trabajar <code class="language-plaintext highlighter-rouge">lubridate</code> y selecciono la columna <code class="language-plaintext highlighter-rouge">CANTIDAD</code>. Luego hago una suma de los registros para cada uno de los días del año y calculo 3 variables nuevas:</p><ul><li><code class="language-plaintext highlighter-rouge">DIA</code>: Una variable que contiene qué día de la semana (lunes, martes, miercoles, …) es cada fecha. Adicionalente, defino que el idioma para mostrar las etiquetas de los días sea español, usando el argumento <code class="language-plaintext highlighter-rouge">locale</code>.<li><code class="language-plaintext highlighter-rouge">MES</code>: Una variable que indica el mes del registro, con las etiquetas en español.<li><code class="language-plaintext highlighter-rouge">SEMANA</code>: Una variable que indica la semana del año a la que pertenece cada fecha,de 1 a 52, usando la función <code class="language-plaintext highlighter-rouge">isoweek()</code>.</ul><p>Ahora bien, como puedes ver, hay una línea de código que modifica manualmente la variable semana. Esto sucede porque <code class="language-plaintext highlighter-rouge">isoweek()</code> define automáticamente la última semana del año como 1, si contiene algún día del año siguiente. Por esta razón, definimos que si el mes es diciembre y la semana del año es 1, la convierta en la semana 53.</p><p>Finalmente, se crea una variable <code class="language-plaintext highlighter-rouge">SEMANA_MES</code>, de tal manera que se tenga a cuál semana de cada mes pertenece la fecha (1-4) y no la semana del año como en la variable <code class="language-plaintext highlighter-rouge">SEMANA</code> (1-52).</p><h2 id="el-calendario">El calendario</h2><p>Ahora si, después de todo lo anterior, podemos generar el calendario con el siguiente código:</p><div class="language-r highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="n">historico_diario</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIA</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">SEMANA_MES</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">REGISTROS</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_tile</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_text</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">day</span><span class="p">(</span><span class="n">FECHA</span><span class="p">)),</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2.5</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">aspect.ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">/</span><span class="m">2</span><span class="p">,</span><span class="w">
        </span><span class="n">legend.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"right"</span><span class="p">,</span><span class="w">
        </span><span class="n">axis.title.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
        </span><span class="n">axis.title.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
        </span><span class="n">axis.text.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
        </span><span class="n">panel.grid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
        </span><span class="n">axis.ticks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
        </span><span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
        </span><span class="n">legend.title.align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w">
        </span><span class="n">strip.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">(),</span><span class="w">
        </span><span class="n">strip.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"bold"</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">),</span><span class="w">
        </span><span class="n">panel.border</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_rect</span><span class="p">(</span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"grey"</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="o">=</span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">),</span><span class="w">
        </span><span class="n">plot.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">18</span><span class="p">,</span><span class="w"> </span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"bold"</span><span class="p">,</span><span class="w">
                                  </span><span class="n">margin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">margin</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0.5</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"cm"</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">scale_fill_viridis_c</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Registros"</span><span class="p">,</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1</span><span class="p">,</span><span class="w"> 
                       </span><span class="n">guide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">guide_colourbar</span><span class="p">(</span><span class="n">title.position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"top"</span><span class="p">,</span><span class="w"> 
                                               </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"vertical"</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">MES</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">scales</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"free"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Comportamiento de la violencia intrafamiliar \nen Colombia durante 2019"</span><span class="p">,</span><span class="w">
       </span><span class="n">caption</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Fuente: SIEDCO"</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><p>Si bien esto puede parecer muy complejo, la mayoría de instrucciones tienen que ver con que no salgan colores ni lineas en el fondo del gráfico, como es el comportamiento por defecto de <code class="language-plaintext highlighter-rouge">ggplot2</code>, y algunos ajustes del tamaño y posición del texto.</p><p>Lo más importante está en que entiedas el llamado inicial de <code class="language-plaintext highlighter-rouge">ggplot()</code>, en el que se usan las variables de <code class="language-plaintext highlighter-rouge">DIA</code> y <code class="language-plaintext highlighter-rouge">SEMANA_MES</code> para construir la grilla que mencioné anteriormente, y se mapea el color a la variable de <code class="language-plaintext highlighter-rouge">REGISTROS</code>.</p><p>Cuando corras ese código, vas a tener el siguiente resultado:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/2021-05-19-mapas-de-calor-como-calendarios-en-R/calendar_heatmap.png" alt="Calendar Heatmap" /> <em>Mapa de calor en forma de calendario</em></p><h2 id="un-ajuste-menor-al-texto">Un ajuste menor al texto</h2><p>Como te podrás dar cuenta, los números en color blanco no son fáciles de leer cuando el color del día es más claro. Esto podrías solucionarlo cambiando el color del texto o, como hice yo, usando el paquete <code class="language-plaintext highlighter-rouge">shadowtext</code>.</p><p>Este paquete incluye una función para <code class="language-plaintext highlighter-rouge">ggplot2</code> que funciona muy parecido a <code class="language-plaintext highlighter-rouge">geom_text()</code>, sólo que añade una sombra alrededor del texto: <code class="language-plaintext highlighter-rouge">geom_shadowtext()</code>. Reemplazando esta función en el código de arriba, ¡queda listo el mapa de calor con forma de calendario!</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/posts/2021-05-19-mapas-de-calor-como-calendarios-en-R/calendar_heatmap_shadow.png" alt="Calendar Heatmap Shadow" /> <em>Mapa de calor en forma de calendario con sombras</em></p><p>Con esta visualización podemos ver rápidamente que parece haber unos picos de registros de violencia intrafamiliar en fechas como navidad, año nuevo y el día de la madre, y que en términos generales parece que se registran más casos en los fines de semana. ¿Ves lo fácil que es extraer toda esta información con una sóla mirada?</p><p>Espero que te haya gustado este post y que ahora puedas experimentar con mapas de calor en forma de calendario para datos de otros temas.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/r/'>R</a>, <a href='/categories/tutorial/'>Tutorial</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/r/" class="post-tag no-text-decoration" >r</a> <a href="/tags/calendar/" class="post-tag no-text-decoration" >calendar</a> <a href="/tags/heatmap/" class="post-tag no-text-decoration" >heatmap</a> <a href="/tags/dataviz/" class="post-tag no-text-decoration" >dataviz</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> Esta publicación está autorizada bajo licencia <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> por el autor.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Mapas de calor como calendarios en R - Camilo Martínez&url=https://camartinezbu.github.io/posts/mapas-de-calor-como-calendarios-en-R/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Mapas de calor como calendarios en R - Camilo Martínez&u=https://camartinezbu.github.io/posts/mapas-de-calor-como-calendarios-en-R/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://camartinezbu.github.io/posts/mapas-de-calor-como-calendarios-en-R/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Actualizaciones recientes</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/mapas-de-calor-como-calendarios-en-R/">Mapas de calor como calendarios en R</a><li><a href="/posts/3-funciones-de-dplyr-que-no-sabias-que-existian/">3 funciones de dplyr que no sabías que existían</a><li><a href="/posts/estructuras-de-datos-basicas-en-python/">Estructuras de datos básicas en python</a><li><a href="/posts/4-paquetes-que-debes-conocer-para-hacer-mapas-en-r/">4 paquetes que debes conocer para hacer mapas en R</a></ul></div><div id="access-tags"> <span>Etiquetas populares</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/r/">r</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/dataviz/">dataviz</a> <a class="post-tag" href="/tags/ggplot/">ggplot</a> <a class="post-tag" href="/tags/leaflet/">leaflet</a> <a class="post-tag" href="/tags/mapas/">mapas</a> <a class="post-tag" href="/tags/sf/">sf</a> <a class="post-tag" href="/tags/tmap/">tmap</a> <a class="post-tag" href="/tags/arrays/">arrays</a> <a class="post-tag" href="/tags/calendar/">calendar</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contenido</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Lecturas relacionadas</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/como-hacer-un-dashboard-en-r/"><div class="card-body"> <span class="timeago small" > Aug 17, 2020 <i class="unloaded">2020-08-17T12:10:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>¿Cómo hacer un dashboard en R?</h3><div class="text-muted small"><p> Los tableros o dashboards son herramientas muy útiles para extraer conclusiones de los datos, en ocasiones más convenientes que realizar muchas gráficas en excel para luego incluirlas en una presen...</p></div></div></a></div><div class="card"> <a href="/posts/4-paquetes-que-debes-conocer-para-hacer-mapas-en-r/"><div class="card-body"> <span class="timeago small" > Jan 17 <i class="unloaded">2021-01-17T09:45:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>4 paquetes que debes conocer para hacer mapas en R</h3><div class="text-muted small"><p> Así que decidiste aprender a usar R para trabajar con mapas. Esta guia te dará las herramientas básicas para que puedas hacerlo, incluyas visualizaciones de mapas en tu flujo de trabajo y te motive...</p></div></div></a></div><div class="card"> <a href="/posts/3-funciones-de-dplyr-que-no-sabias-que-existian/"><div class="card-body"> <span class="timeago small" > Feb 21 <i class="unloaded">2021-02-21T10:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>3 funciones de dplyr que no sabías que existían</h3><div class="text-muted small"><p> Dplyr es quizás uno de los paquetes más importantes del Tidyverse pues permite manipular dataframes fácilmente en R, a través de funciones como mutate(), select(), filter(), summarise(), arrange() ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/que-son-las-expresiones-regulares/" class="btn btn-outline-primary"><p>¿Qué son las expresiones regulares?</p></a> <span class="btn btn-outline-primary disabled"><p>-</p></span></div><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//camartinezbu.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'https://camartinezbu.github.io/posts/mapas-de-calor-como-calendarios-en-R/'; this.page.identifier = '/posts/mapas-de-calor-como-calendarios-en-R/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/camartinezbu">Camilo Martinez</a>. <span data-toggle="tooltip" data-placement="top" title="Excepto donde se indique lo contrario, las publicaciones de este blog se encuentran autorizadas por el autor bajo Creative Commons Attribution 4.0 International (CC BY 4.0).">Algunos derechos reservados.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Etiquetas populares</h4><a class="post-tag" href="/tags/r/">r</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/dataviz/">dataviz</a> <a class="post-tag" href="/tags/ggplot/">ggplot</a> <a class="post-tag" href="/tags/leaflet/">leaflet</a> <a class="post-tag" href="/tags/mapas/">mapas</a> <a class="post-tag" href="/tags/sf/">sf</a> <a class="post-tag" href="/tags/tmap/">tmap</a> <a class="post-tag" href="/tags/arrays/">arrays</a> <a class="post-tag" href="/tags/calendar/">calendar</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://camartinezbu.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
